<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DLO Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --brand: #0176d3;
      --brand-dark: #014486;
      --brand-light: #e1f0ff;
      --nav-bg: #032d60;
      --text: #181818;
      --text-muted: #706e6b;
      --border: #d8dde6;
      --bg: #f4f6f9;
      --card-bg: #ffffff;
      --radius: 8px;
      --shadow: 0 2px 4px rgba(0,0,0,.08);
      --font: 'Salesforce Sans', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: var(--font); margin: 0; background: var(--bg); color: var(--text); font-size: 13px; }

    /* Hide app until gate clears */
    header, main { display: none; }
    body.app-ready header { display: flex; }
    body.app-ready main { display: grid; }

    /* ---- Header (Salesforce Global Nav style) ---- */
    header {
      background: var(--nav-bg);
      color: #fff;
      padding: 0 16px;
      height: 48px;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,.2);
      z-index: 10;
      position: relative;
    }
    header strong { font-size: 15px; letter-spacing: .3px; }
    header .status { font-size: 12px; color: rgba(255,255,255,.7); }
    header .spacer { flex: 1; }
    header button {
      background: rgba(255,255,255,.15);
      color: #fff;
      border: 1px solid rgba(255,255,255,.25);
      padding: 6px 16px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s;
    }
    header button:hover { background: rgba(255,255,255,.25); }

    /* ---- Main layout ---- */
    main {
      grid-template-columns: 280px 1fr;
      height: calc(100vh - 48px);
    }

    /* ---- Sidebar ---- */
    aside {
      background: var(--card-bg);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sidebar-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-header input {
      width: 100%;
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 13px;
      outline: none;
      transition: border-color .15s, box-shadow .15s;
    }
    .sidebar-header input:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(1,118,211,.15);
    }
    .sidebar-count {
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .5px;
      border-bottom: 1px solid var(--border);
      background: #fafbfc;
    }
    #dloList {
      flex: 1;
      overflow: auto;
      padding: 4px 0;
    }
    .dlo {
      padding: 10px 12px;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: background .1s, border-color .1s;
    }
    .dlo:hover { background: var(--brand-light); }
    .dlo.active {
      background: var(--brand-light);
      border-left-color: var(--brand);
    }
    .dlo-name { font-weight: 600; font-size: 13px; color: var(--text); }
    .dlo-api { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

    /* ---- Right content area ---- */
    section {
      overflow: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ---- Toolbar row ---- */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 12px;
      box-shadow: var(--shadow);
    }
    .toolbar label { font-size: 12px; font-weight: 600; color: var(--text-muted); }
    .toolbar input[type=number] {
      width: 80px;
      padding: 5px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 13px;
    }
    .toolbar input[type=number]:focus {
      border-color: var(--brand);
      outline: none;
      box-shadow: 0 0 0 3px rgba(1,118,211,.15);
    }
    .toolbar .pill {
      font-size: 11px;
      padding: 3px 10px;
      background: var(--brand-light);
      color: var(--brand-dark);
      border-radius: 12px;
      font-weight: 600;
    }

    /* ---- Buttons (Salesforce Lightning style) ---- */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--brand);
      cursor: pointer;
      transition: background .12s, border-color .12s;
    }
    .btn:hover { background: #f4f6f9; border-color: var(--brand); }
    .btn:disabled { opacity: .45; cursor: default; }
    .btn-brand {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }
    .btn-brand:hover { background: var(--brand-dark); }
    .btn-sm { padding: 4px 10px; font-size: 11px; }

    /* ---- Grid layout for panels ---- */
    .content-grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 12px;
      align-items: start;
      flex: 1;
      min-height: 0;
    }

    /* ---- Card / Panel ---- */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card-header {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: #fafbfc;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-header strong { font-size: 13px; }
    .card-body { padding: 12px; }

    /* ---- Field search inside card ---- */
    .field-search {
      width: 100%;
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 13px;
      margin-bottom: 6px;
    }
    .field-search:focus {
      border-color: var(--brand);
      outline: none;
      box-shadow: 0 0 0 3px rgba(1,118,211,.15);
    }
    .field-count {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 600;
      margin-bottom: 8px;
    }
    #fieldList { max-height: 42vh; overflow: auto; }
    #fieldList label {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
    }
    #fieldList label:last-child { border-bottom: none; }
    #fieldList .field-label { font-weight: 600; font-size: 12px; }
    #fieldList .field-api { font-size: 11px; color: var(--text-muted); }

    /* ---- WHERE / SQL section ---- */
    .query-section { margin-top: 10px; }
    .query-section .section-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .4px;
      margin-bottom: 6px;
    }
    .query-section input[type=text],
    .query-section textarea {
      width: 100%;
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 13px;
      font-family: var(--font);
    }
    .query-section input:focus,
    .query-section textarea:focus {
      border-color: var(--brand);
      outline: none;
      box-shadow: 0 0 0 3px rgba(1,118,211,.15);
    }
    .query-section textarea { resize: vertical; }

    /* ---- SQL output ---- */
    .sql-output {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
      word-break: break-all;
    }
    .sql-output code {
      background: #f4f6f9;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }

    /* ---- Meta header ---- */
    .meta-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      font-size: 12px;
      color: var(--text-muted);
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: #fafbfc;
    }
    .meta-row strong { display: block; color: var(--text); font-weight: 600; margin-top: 2px; }

    /* ---- Tabs ---- */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--border);
      margin: 0;
      padding: 0 12px;
      background: #fafbfc;
    }
    .tab {
      padding: 10px 16px;
      cursor: pointer;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 13px;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: color .12s, border-color .12s;
    }
    .tab:hover { color: var(--brand); }
    .tab.active { color: var(--brand); border-bottom-color: var(--brand); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; padding: 12px; }

    /* ---- Tables ---- */
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; text-align: left; padding: 8px 10px; font-size: 12px; }
    th {
      position: sticky; top: 0;
      background: #fafbfc;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: .4px;
      cursor: pointer;
      border-bottom: 2px solid var(--border);
    }
    /* Data Explorer table: two-line header (label + api name) */
    #tableWrap th {
      text-transform: none;
      font-size: 12px;
      padding: 6px 10px;
      vertical-align: bottom;
      line-height: 1.3;
    }
    #tableWrap th .th-label { display: block; font-weight: 700; color: var(--text); white-space: nowrap; }
    #tableWrap th .th-api { display: block; font-weight: 400; font-size: 10px; color: var(--text-muted); white-space: nowrap; letter-spacing: .2px; margin-top: 1px; }
    .num { width: 36px; color: var(--text-muted); text-align: right; padding-right: 10px; }
    .table-scroll { overflow: auto; max-height: 75vh; }

    code { background: #f4f6f9; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    .muted { color: var(--text-muted); font-size: 12px; }

    /* ---- Related Objects / Lineage ---- */
    .lineage-section { margin-bottom: 16px; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    .lineage-section-header {
      padding: 10px 12px; background: #f0f4f8; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 8px;
    }
    .lineage-section-header strong { font-size: 13px; }
    .lineage-section-header .badge {
      font-size: 10px; padding: 2px 8px; border-radius: 10px;
      background: var(--brand-light); color: var(--brand-dark); font-weight: 600;
    }
    .lineage-section-header .badge-muted {
      background: #eee; color: var(--text-muted);
    }
    .lineage-subsection { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; }
    .lineage-subsection:last-child { border-bottom: none; }
    .lineage-subsection .sub-title {
      font-size: 11px; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: .4px; margin-bottom: 6px;
    }
    .lineage-debug { font-size: 11px; color: var(--text-muted); padding: 6px 0; word-break: break-all; }
    .lineage-arrow { color: var(--brand); font-weight: 600; }
    .join-pair { font-size: 12px; line-height: 1.6; }
    .join-pair .arrow { color: var(--brand); margin: 0 4px; }

    /* ---- Site-gate overlay ---- */
    #siteGate {
      display: none;
      position: fixed; inset: 0;
      background: linear-gradient(135deg, #032d60 0%, #0176d3 100%);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    #siteGate.visible { display: flex; }
    #siteGate form {
      background: var(--card-bg);
      padding: 36px 32px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,.25);
      display: flex;
      flex-direction: column;
      gap: 14px;
      min-width: 340px;
    }
    #siteGate h2 { margin: 0; font-size: 20px; color: var(--nav-bg); }
    #siteGate .muted { margin: 0; }
    #siteGate input {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 14px;
    }
    #siteGate input:focus {
      border-color: var(--brand);
      outline: none;
      box-shadow: 0 0 0 3px rgba(1,118,211,.2);
    }
    #siteGate button[type=submit] {
      background: var(--brand);
      color: #fff;
      border: none;
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: background .15s;
    }
    #siteGate button[type=submit]:hover { background: var(--brand-dark); }
    #siteGate .error { color: #ea001e; font-size: 13px; min-height: 18px; }
  </style>
</head>
<body>
  <!-- Site-access gate -->
  <div id="siteGate">
    <form id="siteGateForm" autocomplete="on">
      <h2>DLO Explorer</h2>
      <p class="muted">Enter credentials to continue</p>
      <input id="siteUser" name="username" type="text" placeholder="Username" autocomplete="username" required />
      <input id="sitePass" name="password" type="password" placeholder="Password" autocomplete="current-password" required />
      <button type="submit">Sign in</button>
      <div class="error" id="siteGateError"></div>
    </form>
  </div>

  <header>
    <strong>DLO Explorer</strong>
    <span id="status" class="status">Checking auth…</span>
    <div class="spacer"></div>
    <button id="loginBtn" style="display:none">Log In</button>
    <button id="logoutBtn" style="display:none">Log Out</button>
  </header>

  <main>
    <aside>
      <div class="sidebar-header">
        <input id="dloSearch" placeholder="Search DLOs…" />
      </div>
      <div class="sidebar-count" id="dloCount">0 DLOs</div>
      <div id="dloList"></div>
    </aside>

    <section>
      <div class="toolbar">
        <label>Rows</label>
        <input id="limit" type="number" min="1" max="5000" value="100" />
        <label>Offset</label>
        <input id="offset" type="number" min="0" value="0" />
        <button class="btn btn-sm" id="prevBtn">◀ Prev</button>
        <button class="btn btn-sm" id="nextBtn">Next ▶</button>
        <div style="flex:1"></div>
        <span class="pill" id="selectedDloPill">No DLO selected</span>
      </div>

      <div class="content-grid">
        <!-- Left: Field picker & query controls -->
        <div class="card">
          <div class="card-header">
            <strong>Fields</strong>
            <div style="flex:1"></div>
            <button class="btn btn-sm" id="allFieldsBtn">All</button>
            <button class="btn btn-sm" id="noFieldsBtn">None</button>
          </div>
          <div class="card-body">
            <input class="field-search" id="fieldSearch" placeholder="Search fields…" />
            <div class="field-count" id="fieldCount"></div>
            <div id="fieldList"></div>

            <div class="query-section">
              <div class="section-label">WHERE clause</div>
              <input type="text" id="where" placeholder='e.g. "Status__c" = &#39;Active&#39;' />
            </div>

            <div class="query-section">
              <label style="display:flex; gap:8px; align-items:center; font-size:12px; font-weight:600;">
                <input type="checkbox" id="useCustomSql" />
                Custom SQL
              </label>
              <textarea id="customSql" rows="4" style="display:none; margin-top:6px;"></textarea>
              <div class="muted" style="margin-top:4px;">Overrides field selection &amp; WHERE.</div>
            </div>

            <div style="display:flex; gap:6px; margin-top:12px; flex-wrap:wrap;">
              <button class="btn btn-brand" id="runBtn">▶ Run Preview</button>
              <button class="btn" id="copySqlBtn" disabled>Copy SQL</button>
              <button class="btn" id="csvBtn" disabled>Export CSV</button>
            </div>
            <div class="muted" style="margin-top:8px;" id="queryMeta"></div>
            <div class="sql-output">SQL: <code id="sqlText">—</code></div>
          </div>
        </div>

        <!-- Right: Schema & Data tabs -->
        <div class="card">
          <div class="meta-row">
            <div>
              <span>Label</span>
              <strong id="metaLabel">—</strong>
            </div>
            <div>
              <span>API Name</span>
              <strong id="metaApi">—</strong>
            </div>
            <div>
              <span>Category</span>
              <strong id="metaCategory">—</strong>
            </div>
          </div>

          <div class="tabs">
            <div class="tab" data-tab="fieldsTab">Fields</div>
            <div class="tab" data-tab="keysTab">Primary Keys</div>
            <div class="tab" data-tab="relsTab">Related Objects</div>
            <div class="tab active" data-tab="dataTab">Data Explorer</div>
          </div>

          <div id="fieldsTab" class="tab-panel">
            <div class="table-scroll" id="fieldsWrap"></div>
          </div>
          <div id="keysTab" class="tab-panel">
            <div class="table-scroll" id="keysWrap"></div>
          </div>
          <div id="relsTab" class="tab-panel">
            <div class="lineage-debug" id="relatedObjectsMeta"></div>
            <div id="relsWrap"></div>
          </div>
          <div id="dataTab" class="tab-panel active">
            <div class="table-scroll" id="tableWrap"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
  const state = {
    dlos: [],
    entity: null,
    selectedDlo: null,
    fields: [],
    selectedFields: new Set(),
    lastSql: "",
    lastRows: [],
    lastResultColumns: [],
    sort: { field: "", dir: "ASC" }
  };

  // Map uppercase result column names back to metadata field names
  function findMetadataFieldName(resultColName) {
    const lower = (resultColName || "").toLowerCase();
    const match = state.fields.find(f => f.name.toLowerCase() === lower);
    return match ? match.name : resultColName;
  }

  // Parse column names from a SELECT statement and sync selected fields
  function syncFieldsFromSql(sql) {
    if (!sql || !state.fields.length) return;
    const m = sql.match(/^\s*SELECT\s+(.+?)\s+FROM\s/i);
    if (!m) return;
    const selectPart = m[1].trim();
    if (selectPart === "*") {
      state.fields.forEach(f => state.selectedFields.add(f.name));
      renderFields();
      return;
    }
    // Split by comma, strip quotes and whitespace
    const cols = selectPart.split(",").map(c => c.trim().replace(/^"|"$/g, "").trim()).filter(Boolean);
    const colsLower = cols.map(c => c.toLowerCase());
    const matched = state.fields.filter(f => colsLower.includes(f.name.toLowerCase()));
    if (matched.length > 0) {
      state.selectedFields = new Set(matched.map(f => f.name));
      renderFields();
    }
  }

  // Get the display label for a result column name
  function getFieldLabel(resultColName) {
    const lower = (resultColName || "").toLowerCase();
    const match = state.fields.find(f => f.name.toLowerCase() === lower);
    return match?.displayName || resultColName;
  }

  const el = (id) => document.getElementById(id);

  function esc(s) {
    const d = document.createElement("div");
    d.appendChild(document.createTextNode(String(s ?? "")));
    return d.innerHTML;
  }

  function setStatus(txt) { el("status").textContent = txt; }

  async function api(path, opts={}) {
    const r = await fetch(path, opts);
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  function renderDlos() {
    const q = el("dloSearch").value.trim().toLowerCase();
    const filtered = state.dlos.filter(d => (d.displayName || d.name).toLowerCase().includes(q));
    el("dloCount").textContent = `${filtered.length} DLOs`;
    el("dloList").innerHTML = filtered.map(d => `
      <div class="dlo ${state.selectedDlo===d.name ? "active" : ""}" data-name="${esc(d.name)}">
        <div class="dlo-name">${esc(d.displayName || d.name)}</div>
        <div class="dlo-api">${esc(d.name)} ${d.category ? "• " + esc(d.category) : ""}</div>
      </div>
    `).join("");

    document.querySelectorAll(".dlo").forEach(node => {
      node.addEventListener("click", () => selectDlo(node.dataset.name));
    });
  }

  function renderFields() {
    const q = el("fieldSearch").value.trim().toLowerCase();
    const filtered = state.fields.filter(f =>
      (f.displayName || f.name).toLowerCase().includes(q) || f.name.toLowerCase().includes(q)
    );
    el("fieldCount").textContent = `${filtered.length} fields (selected: ${state.selectedFields.size})`;

    el("fieldList").innerHTML = filtered.map(f => `
      <label>
        <input type="checkbox" data-f="${esc(f.name)}" ${state.selectedFields.has(f.name) ? "checked" : ""} />
        <span>
          <div class="field-label">${esc(f.displayName || f.name)}</div>
          <div class="field-api">${esc(f.name)} • ${esc(f.type || "?")}</div>
        </span>
      </label>
    `).join("");

    el("fieldList").querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.addEventListener("change", () => {
        const f = cb.dataset.f;
        if (cb.checked) state.selectedFields.add(f);
        else state.selectedFields.delete(f);
        renderFields();
      });
    });
  }

  function setSelectedDloPill() {
    el("selectedDloPill").textContent = state.selectedDlo ? `Selected: ${state.selectedDlo}` : "No DLO selected";
  }

  function setMetaHeader(entity) {
    el("metaLabel").textContent = entity?.displayName || "—";
    el("metaApi").textContent = entity?.name || "—";
    el("metaCategory").textContent = entity?.category || "—";
  }

  function renderSchema() {
    const fields = (state.entity?.fields || []).slice();
    const keys = (state.entity?.primaryKeys || []).slice();

    if (!fields.length) {
      el("fieldsWrap").innerHTML = `<div class="muted">No fields found.</div>`;
    } else {
      const rows = fields.map((f, i) => `
        <tr>
          <td class="num">${i + 1}</td>
          <td>${esc(f.displayName || f.name)}</td>
          <td>${esc(f.name)}</td>
          <td>${esc(f.type)}</td>
        </tr>
      `).join("");

      el("fieldsWrap").innerHTML = `
        <table class="schema-table">
          <thead>
            <tr>
              <th class="num">#</th>
              <th>Label</th>
              <th>API Name</th>
              <th>Data Type</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    if (!keys.length) {
      el("keysWrap").innerHTML = `<div class="muted">No primary keys found.</div>`;
    } else {
      const rows = keys.map((k, i) => `
        <tr>
          <td class="num">${i + 1}</td>
          <td>${esc(k.displayName || k.name)}</td>
          <td>${esc(k.name)}</td>
          <td>${esc(k.indexOrder ?? "")}</td>
        </tr>
      `).join("");

      el("keysWrap").innerHTML = `
        <table class="schema-table">
          <thead>
            <tr>
              <th class="num">#</th>
              <th>Label</th>
              <th>API Name</th>
              <th>Index Order</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    // Related Objects: loaded asynchronously via dedicated endpoint
    el("relsWrap").innerHTML = `<div class="muted">Select the Related Objects tab to load lineage data.</div>`;
    el("relatedObjectsMeta").textContent = "";
  }

  async function selectDlo(name) {
    state.selectedDlo = name;
    setSelectedDloPill();
    renderDlos();

    setStatus(`Loading fields for ${name}…`);
    const meta = await api(`/api/dlo/${encodeURIComponent(name)}/meta`);
    state.entity = meta.entity;
    state.fields = (meta.entity.fields || []).slice().sort((a,b) => a.name.localeCompare(b.name));
    state.selectedFields = new Set(state.fields.map(f => f.name));
    state.sort = { field: "", dir: "ASC" };
    state.lastResultColumns = [];
    relatedObjectsLoaded = false;
    el("customSql").value = `SELECT * FROM "${name}"`;
    setMetaHeader(meta.entity);
    renderSchema();
    renderFields();

    // Switch to Data Explorer tab
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
    document.querySelector('[data-tab="dataTab"]').classList.add("active");
    el("dataTab").classList.add("active");

    // Auto-load rows
    el("offset").value = 0;
    await runPreview();
  }

  function buildOrderBy() {
    // Use explicitly set sort field (from clicking a column header)
    if (state.sort.field) {
      // Validate sort field is still in selected fields (unless using custom SQL)
      if (!el("useCustomSql").checked && state.selectedFields.size > 0 && !state.selectedFields.has(state.sort.field)) {
        state.sort.field = "";
      } else {
        return `${state.sort.field} ${state.sort.dir || "ASC"}`;
      }
    }
    // Auto-fallback: use first column from last successful query results
    if (state.lastResultColumns.length > 0) {
      const metaName = findMetadataFieldName(state.lastResultColumns[0]);
      if (metaName) return `${metaName} ASC`;
    }
    return "";
  }

  async function runPreview() {
    try {
      if (!state.selectedDlo) return alert("Select a DLO first.");
      const limit = Number(el("limit").value || 100);
      const offset = Number(el("offset").value || 0);
      const where = el("where").value || "";

      const useCustomSql = el("useCustomSql").checked;
      const customSql = el("customSql").value || "";
      const fields = Array.from(state.selectedFields);
      if (!useCustomSql && fields.length === 0) {
        return alert("Select at least 1 field (or click All).");
      }

      setStatus("Querying…");
      const orderby = offset > 0 ? buildOrderBy() : buildOrderBy();
      if (offset > 0 && !orderby) {
        return alert("Pagination requires sorting. Please run a preview first (▶ Run Preview), then use Prev/Next to paginate.");
      }

      const payload = {
        fields,
        limit,
        offset,
        orderby,
        where,
        sql: useCustomSql ? customSql : ""
      };

      const out = await api(`/api/dlo/${encodeURIComponent(state.selectedDlo)}/preview`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      state.lastSql = out.sql;
      el("sqlText").textContent = out.sql;
      el("copySqlBtn").disabled = false;

      const result = out.result || {};
      const rows = result.data || [];
      state.lastRows = rows;
      state.lastResultColumns = rows.length > 0 ? Object.keys(rows[0]) : [];
      el("csvBtn").disabled = rows.length === 0;

      el("queryMeta").textContent =
        `rowCount=${result.rowCount ?? "?"} • done=${result.done ?? "?"} • queryId=${result.queryId ?? "?"}`;

      renderTable(rows);
      setStatus("Ready");
    } catch (e) {
      setStatus("Error");
      alert(e);
    }
  }

  function renderTable(rows) {
    if (!rows || rows.length === 0) {
      el("tableWrap").innerHTML = `<div class="muted">No rows returned.</div>`;
      return;
    }

    const cols = Object.keys(rows[0]);
    const header = cols.map(c => {
      const label = getFieldLabel(c);
      const apiName = findMetadataFieldName(c);
      return `<th data-col="${esc(c)}"><span class="th-label">${esc(label)}</span><span class="th-api">${esc(apiName)}</span></th>`;
    }).join("");
    const body = rows.map(r => `
      <tr>${cols.map(c => `<td>${esc(r[c])}</td>`).join("")}</tr>
    `).join("");

    el("tableWrap").innerHTML = `
      <table>
        <thead><tr>${header}</tr></thead>
        <tbody>${body}</tbody>
      </table>
    `;

    el("tableWrap").querySelectorAll("th").forEach(th => {
      th.addEventListener("click", async () => {
        const col = findMetadataFieldName(th.dataset.col);
        if (state.sort.field === col) {
          state.sort.dir = (state.sort.dir === "ASC") ? "DESC" : "ASC";
        } else {
          state.sort.field = col;
          state.sort.dir = "ASC";
        }
        await runPreview();
      });
    });
  }

  // ---- Related Objects / Lineage ----

  let relatedObjectsLoaded = false; // tracks if we've loaded for current DLO

  async function loadRelatedObjects() {
    if (!state.selectedDlo) {
      el("relsWrap").innerHTML = `<div class="muted">Select a DLO first.</div>`;
      return;
    }

    el("relatedObjectsMeta").textContent = "Loading lineage data…";
    el("relsWrap").innerHTML = `<div class="muted">Fetching DLO → DMO mappings and relationships…</div>`;

    try {
      const out = await api(`/api/dlo/${encodeURIComponent(state.selectedDlo)}/related-objects`);
      el("relatedObjectsMeta").textContent =
        `Connect API: ${out.connectAvailable ? "✓ available" : "✗ unavailable (metadata-only mode)"}` +
        ` · DLO rels: ${(out.dloRelationships || []).length}` +
        ` · DMO matches: ${(out.mappedDmos || []).length}` +
        (out.debug?.connectBaseResolved ? ` · Base: ${out.debug.connectBaseResolved}` : "");

      renderRelatedObjects(out);
      relatedObjectsLoaded = true;
    } catch (e) {
      el("relatedObjectsMeta").textContent = "";
      el("relsWrap").innerHTML = `<div class="muted" style="color:#ea001e">Error loading lineage: ${esc(String(e))}</div>`;
    }
  }

  function renderRelatedObjects(out) {
    const pane = el("relsWrap");
    let html = "";

    // Section 1: DLO's own metadata relationships (always available)
    const dloRels = out.dloRelationships || [];
    if (dloRels.length) {
      const dloRelRows = dloRels.map((r, i) => {
        const dirIcon = r.direction === "outgoing" ? "→" : "←";
        const joinHtml = (r.join || []).map(p =>
          `<span class="join-pair"><code>${esc(p.sourceField)}</code><span class="arrow">→</span><code>${esc(p.targetField)}</code></span>`
        ).join("<br/>") || `<span class="muted">—</span>`;

        return `<tr>
          <td class="num">${i + 1}</td>
          <td style="font-weight:600">${esc(r.relatedDmoName || "—")}</td>
          <td>${esc(r.type || "—")}</td>
          <td>${dirIcon} ${esc(r.direction || "")}</td>
          <td>${joinHtml}</td>
        </tr>`;
      }).join("");

      html += `
        <div class="lineage-section">
          <div class="lineage-section-header">
            <strong>DLO Relationships</strong>
            <span class="badge">${dloRels.length} relationship${dloRels.length !== 1 ? "s" : ""}</span>
          </div>
          <div class="lineage-subsection">
            <table class="schema-table">
              <thead>
                <tr>
                  <th class="num">#</th>
                  <th>Related Object</th>
                  <th>Cardinality</th>
                  <th>Direction</th>
                  <th>Join Fields</th>
                </tr>
              </thead>
              <tbody>${dloRelRows}</tbody>
            </table>
          </div>
        </div>`;
    }

    // Section 2: Mapped DMOs (from Connect API)
    const mappedDmos = out.mappedDmos || [];
    if (mappedDmos.length) {
      for (const d of mappedDmos) {
        // Field mappings sub-table
        let fieldMapHtml = "";
        if (d.fieldMappings && d.fieldMappings.length) {
          const fmRows = d.fieldMappings.slice(0, 50).map((fm) => {
            const src = fm?.sourceFieldName || fm?.sourceField || fm?.source?.fieldName || "—";
            const tgt = fm?.targetFieldName || fm?.targetField || fm?.target?.fieldName || "—";
            return `<tr><td><code>${esc(src)}</code></td><td class="lineage-arrow">→</td><td><code>${esc(tgt)}</code></td></tr>`;
          }).join("");

          fieldMapHtml = `
            <div class="lineage-subsection">
              <div class="sub-title">DLO → DMO Field Mappings ${d.fieldMappings.length > 50 ? `(showing 50 of ${d.fieldMappings.length})` : ""}</div>
              <table class="schema-table">
                <thead><tr><th>DLO Field</th><th></th><th>DMO Field</th></tr></thead>
                <tbody>${fmRows}</tbody>
              </table>
            </div>`;
        }

        // Related objects sub-table
        let relObjHtml = "";
        if (d.relatedObjects && d.relatedObjects.length) {
          const roRows = d.relatedObjects.map((r, i) => {
            const dirIcon = r.direction === "outgoing" ? "→" : "←";
            const joinHtml = (r.join || []).map(p =>
              `<span class="join-pair"><code>${esc(p.sourceField)}</code><span class="arrow">→</span><code>${esc(p.targetField)}</code></span>`
            ).join("<br/>") || `<span class="muted">—</span>`;

            return `<tr>
              <td class="num">${i + 1}</td>
              <td style="font-weight:600">${esc(r.relatedDmoName || "—")}</td>
              <td>${esc(r.relationshipName || "—")}</td>
              <td>${esc(r.type || "—")}</td>
              <td>${dirIcon} ${esc(r.direction || "")}</td>
              <td>${joinHtml}</td>
            </tr>`;
          }).join("");

          relObjHtml = `
            <div class="lineage-subsection">
              <div class="sub-title">DMO Relationships</div>
              <table class="schema-table">
                <thead>
                  <tr>
                    <th class="num">#</th>
                    <th>Related Object</th>
                    <th>Relationship</th>
                    <th>Cardinality</th>
                    <th>Direction</th>
                    <th>Join Fields</th>
                  </tr>
                </thead>
                <tbody>${roRows}</tbody>
              </table>
            </div>`;
        } else {
          relObjHtml = `<div class="lineage-subsection"><div class="muted">No relationships found for this DMO.</div></div>`;
        }

        const discoveryLabel = d.discoveredVia === "name-heuristic" ? " (name match)"
          : d.discoveredVia === "metadata-reference" ? " (metadata ref)" : "";
        const discoveryBadge = d.discoveredVia
          ? `<span class="badge badge-muted">via ${esc(d.discoveredVia)}</span>` : "";

        html += `
          <div class="lineage-section">
            <div class="lineage-section-header">
              <strong>${d.discoveredVia ? "Related" : "Mapped"} DMO: ${esc(d.displayName || d.dmoName)}${discoveryLabel}</strong>
              ${discoveryBadge}
              <span class="badge">${(d.relatedObjects || []).length} relationship${(d.relatedObjects || []).length !== 1 ? "s" : ""}</span>
              ${d.fieldMappings?.length ? `<span class="badge badge-muted">${d.fieldMappings.length} field mapping${d.fieldMappings.length !== 1 ? "s" : ""}</span>` : ""}
              ${d.category ? `<span class="badge badge-muted">${esc(d.category)}</span>` : ""}
              ${d.fieldCount ? `<span class="badge badge-muted">${d.fieldCount} fields</span>` : ""}
            </div>
            ${fieldMapHtml}
            ${relObjHtml}
          </div>`;
      }
    }

    if (!html) {
      const checks = [
        `Connect API DLO→DMO mappings: ${out.connectAvailable ? "checked — none found" : "unavailable (auto-discovery failed)"}`,
        `DLO metadata relationships: ${(out.dloRelationships || []).length} found`,
        `DMO metadata scan (name heuristic): ${(out.mappedDmos || []).length} matches`,
        `Raw relationship entries in DLO metadata: ${out.debug?.rawDloRelationshipCount ?? "?"}`,
      ];

      // Show probe log if available
      const probeLog = out.debug?.connectProbeLog || [];
      let probeHtml = "";
      if (probeLog.length) {
        const probeRows = probeLog.map(p => {
          const status = p.error ? `<span style="color:#ea001e">${esc(p.error)}</span>` : `${p.status}`;
          return `<tr><td style="word-break:break-all"><code style="font-size:11px">${esc(p.url)}</code></td><td>${esc(p.tokenKind)}</td><td>${status}</td></tr>`;
        }).join("");
        probeHtml = `
          <br/><strong>Connect API probe log</strong> (${probeLog.length} URLs tried):<br/>
          <div style="overflow-x:auto; margin-top:6px;">
            <table class="schema-table" style="font-size:11px;">
              <thead><tr><th>URL</th><th>Token</th><th>Status</th></tr></thead>
              <tbody>${probeRows}</tbody>
            </table>
          </div>
          <br/>
          <strong>How to fix:</strong><br/>
          &nbsp;&nbsp;1. Visit <code>/api/debug/connect</code> in your browser to re-run the probe<br/>
          &nbsp;&nbsp;2. If all probes return 404 — the Connect API may not be enabled for your org<br/>
          &nbsp;&nbsp;3. If probes return 401/403 — your OAuth scope needs <code>cdp_api</code> or <code>data_cloud_api</code><br/>
          &nbsp;&nbsp;4. If you know the correct base URL, set <code>DC_CONNECT_BASE_URL</code> in your .env file`;
      }

      html = `<div class="muted" style="padding:16px; line-height:1.7;">
        <strong>No relationships found for this DLO.</strong>
        <br/><br/>
        <strong>Diagnostics:</strong><br/>
        ${checks.map(c => `&nbsp;&nbsp;• ${c}`).join("<br/>")}
        ${probeHtml}
        <br/><br/>
        <strong>Common reasons:</strong><br/>
        &nbsp;&nbsp;• SFMC engagement DLOs often have no metadata-level relationships<br/>
        &nbsp;&nbsp;• DLO→DMO mappings are only visible via the Connect API<br/>
        &nbsp;&nbsp;• The Connect API requires specific scopes or a custom base URL<br/>
        <br/>
        <strong>Google search tips:</strong><br/>
        &nbsp;&nbsp;• <code>salesforce "connect api" "data cloud" dataModelObjectMappings site:developer.salesforce.com</code><br/>
        &nbsp;&nbsp;• <code>salesforce cdp connect REST API "/services/data" "/connect/cdp"</code>
      </div>`;
    }

    pane.innerHTML = html;
  }

  function toCsv(rows) {
    if (!rows.length) return "";
    const cols = Object.keys(rows[0]);
    const esc = (v) => {
      const s = (v ?? "").toString().replaceAll('"','""');
      return `"${s}"`;
    };
    return [cols.join(","), ...rows.map(r => cols.map(c => esc(r[c])).join(","))].join("\n");
  }

  async function init() {
    // ---- Site-access gate ----
    try {
      const gateRes = await fetch("/site/status");
      const gate = await gateRes.json();
      if (gate.gateEnabled && !gate.authed) {
        el("siteGate").classList.add("visible");
        el("siteGateForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          el("siteGateError").textContent = "";
          try {
            const r = await fetch("/site/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user: el("siteUser").value, pass: el("sitePass").value }),
            });
            if (!r.ok) {
              const err = await r.json().catch(() => ({}));
              el("siteGateError").textContent = err.error || "Login failed.";
              return;
            }
            el("siteGate").classList.remove("visible");
            initApp();
          } catch (err) {
            el("siteGateError").textContent = "Network error. Please try again.";
          }
        });
        return; // wait for form submit
      }
    } catch (_) { /* gate check failed — proceed normally */ }

    initApp();
  }

  async function initApp() {
    document.body.classList.add("app-ready");
    try {
      const status = await api("/api/status");
      if (!status.loggedIn) {
        setStatus("Not logged in.");
        el("loginBtn").style.display = "";
        el("loginBtn").onclick = () => location.href = "/auth/login";
        return;
      }

      el("logoutBtn").style.display = "";
      el("logoutBtn").onclick = async () => {
        await fetch("/auth/logout", { method: "POST" });
        location.reload();
      };

      setStatus("Loading DLOs…");
      const dlos = await api("/api/dlos");
      state.dlos = dlos.dlos || [];
      renderDlos();
      setSelectedDloPill();
      setStatus("Ready (select a DLO).");
    } catch (e) {
      setStatus("Error");
      alert(e);
    }
  }

  el("dloSearch").addEventListener("input", renderDlos);
  el("fieldSearch").addEventListener("input", renderFields);
  el("allFieldsBtn").addEventListener("click", () => { state.fields.forEach(f => state.selectedFields.add(f.name)); renderFields(); });
  el("noFieldsBtn").addEventListener("click", () => { state.selectedFields.clear(); renderFields(); });
  el("runBtn").addEventListener("click", runPreview);
  el("useCustomSql").addEventListener("change", () => {
    const checked = el("useCustomSql").checked;
    el("customSql").style.display = checked ? "" : "none";
    if (checked && el("customSql").value.trim()) {
      syncFieldsFromSql(el("customSql").value);
    }
  });

  el("customSql").addEventListener("input", () => {
    if (el("useCustomSql").checked) {
      syncFieldsFromSql(el("customSql").value);
    }
  });

  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      const id = t.dataset.tab;
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
      t.classList.add("active");
      el(id).classList.add("active");

      // Load lineage data on first visit to Related Objects tab for this DLO
      if (id === "relsTab" && !relatedObjectsLoaded && state.selectedDlo) {
        loadRelatedObjects();
      }
    });
  });

  el("prevBtn").addEventListener("click", () => {
    const limit = Number(el("limit").value || 100);
    el("offset").value = Math.max(0, Number(el("offset").value || 0) - limit);
    runPreview();
  });

  el("nextBtn").addEventListener("click", () => {
    const limit = Number(el("limit").value || 100);
    el("offset").value = Number(el("offset").value || 0) + limit;
    runPreview();
  });

  el("copySqlBtn").addEventListener("click", async () => {
    await navigator.clipboard.writeText(state.lastSql || "");
    alert("SQL copied.");
  });

  el("csvBtn").addEventListener("click", () => {
    const csv = toCsv(state.lastRows || []);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${state.selectedDlo || "export"}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  init();
</script>
</body>
</html>
