<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DLO Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    header, main { display: none; }
    body.app-ready header { display:flex; padding: 12px 16px; border-bottom: 1px solid #ddd; gap:12px; align-items:center; }
    body.app-ready main { display: grid; grid-template-columns: 320px 1fr; height: calc(100vh - 58px); }
    aside { border-right: 1px solid #ddd; padding: 12px; overflow:auto; }
    section { padding: 12px; overflow:auto; }
    input, button { padding: 8px; }
    .row { display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
    .dlo { padding: 8px; border: 1px solid #eee; border-radius: 10px; margin: 6px 0; cursor:pointer; }
    .dlo:hover { background: #fafafa; }
    .dlo.active { border-color: #666; background: #f5f5f5; }
    .pill { font-size: 12px; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; }
    .grid { display:grid; grid-template-columns: 340px 1fr; gap: 12px; align-items:start; }
    .panel { border: 1px solid #eee; border-radius: 12px; padding: 10px; }
    .panel-header { display:flex; gap:16px; align-items:center; border-bottom:1px solid #eee; padding-bottom:8px; margin-bottom:8px; }
    .meta-row { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; font-size:12px; color:#666; }
    .meta-row strong { display:block; color:#222; font-weight:600; }
    .tabs { display:flex; gap:16px; border-bottom:1px solid #e5e5e5; margin-top:8px; }
    .tab { padding:8px 2px; cursor:pointer; color:#666; font-weight:600; border-bottom:2px solid transparent; }
    .tab.active { color:#111; border-bottom-color:#2f6fed; }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }
    .table-scroll { margin-top:8px; overflow:auto; max-height: 75vh; }
    .schema-table th { background:#fafafa; }
    .num { width:40px; color:#777; text-align:right; padding-right:10px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; text-align:left; padding: 8px; font-size: 13px; }
    th { position: sticky; top: 0; background: white; cursor:pointer; }
    code { background:#f7f7f7; padding:2px 6px; border-radius: 6px; }
    .muted { color: #666; font-size: 13px; }
    /* Site-gate overlay */
    #siteGate {
      display: none;
      position: fixed; inset: 0;
      background: #f5f5f5;
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    #siteGate.visible { display: flex; }
    #siteGate form {
      background: white;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.10);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 300px;
    }
    #siteGate h2 { margin: 0 0 4px; }
    #siteGate .error { color: #c00; font-size: 13px; min-height: 18px; }
  </style>
</head>
<body>
  <!-- Site-access gate -->
  <div id="siteGate">
    <form id="siteGateForm" autocomplete="on">
      <h2>DLO Explorer</h2>
      <p class="muted">Enter credentials to continue</p>
      <input id="siteUser" name="username" type="text" placeholder="Username" autocomplete="username" required />
      <input id="sitePass" name="password" type="password" placeholder="Password" autocomplete="current-password" required />
      <button type="submit">Sign in</button>
      <div class="error" id="siteGateError"></div>
    </form>
  </div>

  <header>
    <strong>DLO Explorer</strong>
    <span id="status" class="muted">Checking auth…</span>
    <div style="flex:1"></div>
    <button id="loginBtn" style="display:none">Login</button>
    <button id="logoutBtn" style="display:none">Logout</button>
  </header>

  <main>
    <aside>
      <div class="row">
        <input id="dloSearch" placeholder="Search DLOs…" style="flex:1" />
      </div>
      <div class="muted" style="margin:10px 0" id="dloCount"></div>
      <div id="dloList"></div>
    </aside>

    <section>
      <div class="row">
        <label>Rows:</label>
        <input id="limit" type="number" min="1" max="5000" value="100" style="width:100px" />
        <label>Offset:</label>
        <input id="offset" type="number" min="0" value="0" style="width:120px" />
        <button id="prevBtn">Prev</button>
        <button id="nextBtn">Next</button>
        <span class="pill" id="selectedDloPill">No DLO selected</span>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div class="panel">
          <div class="row">
            <strong>Fields</strong>
            <div style="flex:1"></div>
            <button id="allFieldsBtn">All</button>
            <button id="noFieldsBtn">None</button>
          </div>
          <input id="fieldSearch" placeholder="Search fields…" style="width:100%; margin:8px 0" />
          <div class="muted" id="fieldCount"></div>
          <div id="fieldList" style="max-height: 50vh; overflow:auto; margin-top:8px;"></div>

          <div style="margin-top:10px;">
            <div class="muted">Optional WHERE (simple):</div>
            <input id="where" placeholder='e.g. "Status__c" = ''Active''' style="width:100%; margin-top:6px" />
          </div>

          <div style="margin-top:12px;">
            <label style="display:flex; gap:8px; align-items:center;">
              <input type="checkbox" id="useCustomSql" />
              <span>Use custom SQL</span>
            </label>
            <textarea id="customSql" rows="5" style="width:100%; margin-top:6px; display:none;"></textarea>
            <div class="muted" style="margin-top:4px;">When enabled, field selection/WHERE are ignored.</div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="runBtn">Run preview</button>
            <button id="copySqlBtn" disabled>Copy SQL</button>
            <button id="csvBtn" disabled>Export CSV</button>
          </div>
          <div class="muted" style="margin-top:8px;" id="queryMeta"></div>
          <div class="muted" style="margin-top:8px;">SQL: <code id="sqlText">—</code></div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <div class="meta-row" style="width:100%">
              <div>
                <span>Label</span>
                <strong id="metaLabel">—</strong>
              </div>
              <div>
                <span>API Name</span>
                <strong id="metaApi">—</strong>
              </div>
              <div>
                <span>Category</span>
                <strong id="metaCategory">—</strong>
              </div>
            </div>
          </div>

          <div class="tabs">
            <div class="tab active" data-tab="fieldsTab">Fields</div>
            <div class="tab" data-tab="keysTab">Primary Keys</div>
            <div class="tab" data-tab="dataTab">Data Explorer</div>
          </div>

          <div id="fieldsTab" class="tab-panel active">
            <div class="table-scroll" id="fieldsWrap"></div>
          </div>
          <div id="keysTab" class="tab-panel">
            <div class="table-scroll" id="keysWrap"></div>
          </div>
          <div id="dataTab" class="tab-panel">
            <div class="table-scroll" id="tableWrap"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
  const state = {
    dlos: [],
    entity: null,
    selectedDlo: null,
    fields: [],
    selectedFields: new Set(),
    lastSql: "",
    lastRows: [],
    sort: { field: "", dir: "ASC" }
  };

  const el = (id) => document.getElementById(id);

  function esc(s) {
    const d = document.createElement("div");
    d.appendChild(document.createTextNode(String(s ?? "")));
    return d.innerHTML;
  }

  function setStatus(txt) { el("status").textContent = txt; }

  async function api(path, opts={}) {
    const r = await fetch(path, opts);
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  function renderDlos() {
    const q = el("dloSearch").value.trim().toLowerCase();
    const filtered = state.dlos.filter(d => (d.displayName || d.name).toLowerCase().includes(q));
    el("dloCount").textContent = `${filtered.length} DLOs`;
    el("dloList").innerHTML = filtered.map(d => `
      <div class="dlo ${state.selectedDlo===d.name ? "active" : ""}" data-name="${esc(d.name)}">
        <div><strong>${esc(d.displayName || d.name)}</strong></div>
        <div class="muted">${esc(d.name)} ${d.category ? "• " + esc(d.category) : ""}</div>
      </div>
    `).join("");

    document.querySelectorAll(".dlo").forEach(node => {
      node.addEventListener("click", () => selectDlo(node.dataset.name));
    });
  }

  function renderFields() {
    const q = el("fieldSearch").value.trim().toLowerCase();
    const filtered = state.fields.filter(f =>
      (f.displayName || f.name).toLowerCase().includes(q) || f.name.toLowerCase().includes(q)
    );
    el("fieldCount").textContent = `${filtered.length} fields (selected: ${state.selectedFields.size})`;

    el("fieldList").innerHTML = filtered.map(f => `
      <label style="display:flex; gap:8px; align-items:center; margin:6px 0;">
        <input type="checkbox" data-f="${esc(f.name)}" ${state.selectedFields.has(f.name) ? "checked" : ""} />
        <span>
          <div><strong>${esc(f.displayName || f.name)}</strong></div>
          <div class="muted">${esc(f.name)} • ${esc(f.type || "?")}</div>
        </span>
      </label>
    `).join("");

    el("fieldList").querySelectorAll("input[type=checkbox]").forEach(cb => {
      cb.addEventListener("change", () => {
        const f = cb.dataset.f;
        if (cb.checked) state.selectedFields.add(f);
        else state.selectedFields.delete(f);
        renderFields();
      });
    });
  }

  function setSelectedDloPill() {
    el("selectedDloPill").textContent = state.selectedDlo ? `Selected: ${state.selectedDlo}` : "No DLO selected";
  }

  function setMetaHeader(entity) {
    el("metaLabel").textContent = entity?.displayName || "—";
    el("metaApi").textContent = entity?.name || "—";
    el("metaCategory").textContent = entity?.category || "—";
  }

  function renderSchema() {
    const fields = (state.entity?.fields || []).slice();
    const keys = (state.entity?.primaryKeys || []).slice();

    if (!fields.length) {
      el("fieldsWrap").innerHTML = `<div class="muted">No fields found.</div>`;
    } else {
      const rows = fields.map((f, i) => `
        <tr>
          <td class="num">${i + 1}</td>
          <td>${esc(f.displayName || f.name)}</td>
          <td>${esc(f.name)}</td>
          <td>${esc(f.type)}</td>
        </tr>
      `).join("");

      el("fieldsWrap").innerHTML = `
        <table class="schema-table">
          <thead>
            <tr>
              <th class="num">#</th>
              <th>Label</th>
              <th>API Name</th>
              <th>Data Type</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    if (!keys.length) {
      el("keysWrap").innerHTML = `<div class="muted">No primary keys found.</div>`;
    } else {
      const rows = keys.map((k, i) => `
        <tr>
          <td class="num">${i + 1}</td>
          <td>${esc(k.displayName || k.name)}</td>
          <td>${esc(k.name)}</td>
          <td>${esc(k.indexOrder ?? "")}</td>
        </tr>
      `).join("");

      el("keysWrap").innerHTML = `
        <table class="schema-table">
          <thead>
            <tr>
              <th class="num">#</th>
              <th>Label</th>
              <th>API Name</th>
              <th>Index Order</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }
  }

  async function selectDlo(name) {
    state.selectedDlo = name;
    setSelectedDloPill();
    renderDlos();

    setStatus(`Loading fields for ${name}…`);
    const meta = await api(`/api/dlo/${encodeURIComponent(name)}/meta`);
    state.entity = meta.entity;
    state.fields = (meta.entity.fields || []).slice().sort((a,b) => a.name.localeCompare(b.name));
    state.selectedFields = new Set(state.fields.map(f => f.name));
    state.sort = { field: "", dir: "ASC" };
    el("customSql").value = `SELECT * FROM "${name}"`;
    setMetaHeader(meta.entity);
    renderSchema();
    renderFields();
    setStatus(`Ready (${name})`);
  }

  function buildOrderBy() {
    const col = state.sort.field || (state.selectedFields.size ? Array.from(state.selectedFields)[0] : "");
    if (!col) return "";
    return `${col} ${state.sort.dir || "ASC"}`;
  }

  async function runPreview() {
    try {
      if (!state.selectedDlo) return alert("Select a DLO first.");
      const limit = Number(el("limit").value || 100);
      const offset = Number(el("offset").value || 0);
      const where = el("where").value || "";

      const useCustomSql = el("useCustomSql").checked;
      const customSql = el("customSql").value || "";
      const fields = Array.from(state.selectedFields);
      if (!useCustomSql && fields.length === 0) {
        return alert("Select at least 1 field (or click All).");
      }

      setStatus("Querying…");
      const orderby = offset > 0 ? buildOrderBy() : buildOrderBy();
      if (offset > 0 && !orderby) {
        return alert("Offset requires order by. Select a column or choose at least one field.");
      }

      const payload = {
        fields,
        limit,
        offset,
        orderby,
        where,
        sql: useCustomSql ? customSql : ""
      };

      const out = await api(`/api/dlo/${encodeURIComponent(state.selectedDlo)}/preview`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      state.lastSql = out.sql;
      el("sqlText").textContent = out.sql;
      el("copySqlBtn").disabled = false;

      const result = out.result || {};
      const rows = result.data || [];
      state.lastRows = rows;
      el("csvBtn").disabled = rows.length === 0;

      el("queryMeta").textContent =
        `rowCount=${result.rowCount ?? "?"} • done=${result.done ?? "?"} • queryId=${result.queryId ?? "?"}`;

      renderTable(rows);
      setStatus("Ready");
    } catch (e) {
      setStatus("Error");
      alert(e);
    }
  }

  function renderTable(rows) {
    if (!rows || rows.length === 0) {
      el("tableWrap").innerHTML = `<div class="muted">No rows returned.</div>`;
      return;
    }

    const cols = Object.keys(rows[0]);
    const header = cols.map(c => `<th data-col="${esc(c)}">${esc(c)}</th>`).join("");
    const body = rows.map(r => `
      <tr>${cols.map(c => `<td>${esc(r[c])}</td>`).join("")}</tr>
    `).join("");

    el("tableWrap").innerHTML = `
      <table>
        <thead><tr>${header}</tr></thead>
        <tbody>${body}</tbody>
      </table>
    `;

    el("tableWrap").querySelectorAll("th").forEach(th => {
      th.addEventListener("click", async () => {
        const col = th.dataset.col;
        if (state.sort.field === col) {
          state.sort.dir = (state.sort.dir === "ASC") ? "DESC" : "ASC";
        } else {
          state.sort.field = col;
          state.sort.dir = "ASC";
        }
        await runPreview();
      });
    });
  }

  function toCsv(rows) {
    if (!rows.length) return "";
    const cols = Object.keys(rows[0]);
    const esc = (v) => {
      const s = (v ?? "").toString().replaceAll('"','""');
      return `"${s}"`;
    };
    return [cols.join(","), ...rows.map(r => cols.map(c => esc(r[c])).join(","))].join("\n");
  }

  async function init() {
    // ---- Site-access gate ----
    try {
      const gateRes = await fetch("/site/status");
      const gate = await gateRes.json();
      if (gate.gateEnabled && !gate.authed) {
        el("siteGate").classList.add("visible");
        el("siteGateForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          el("siteGateError").textContent = "";
          try {
            const r = await fetch("/site/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user: el("siteUser").value, pass: el("sitePass").value }),
            });
            if (!r.ok) {
              const err = await r.json().catch(() => ({}));
              el("siteGateError").textContent = err.error || "Login failed.";
              return;
            }
            el("siteGate").classList.remove("visible");
            initApp();
          } catch (err) {
            el("siteGateError").textContent = "Network error. Please try again.";
          }
        });
        return; // wait for form submit
      }
    } catch (_) { /* gate check failed — proceed normally */ }

    initApp();
  }

  async function initApp() {
    document.body.classList.add("app-ready");
    try {
      const status = await api("/api/status");
      if (!status.loggedIn) {
        setStatus("Not logged in.");
        el("loginBtn").style.display = "";
        el("loginBtn").onclick = () => location.href = "/auth/login";
        return;
      }

      el("logoutBtn").style.display = "";
      el("logoutBtn").onclick = async () => {
        await fetch("/auth/logout", { method: "POST" });
        location.reload();
      };

      setStatus("Loading DLOs…");
      const dlos = await api("/api/dlos");
      state.dlos = dlos.dlos || [];
      renderDlos();
      setSelectedDloPill();
      setStatus("Ready (select a DLO).");
    } catch (e) {
      setStatus("Error");
      alert(e);
    }
  }

  el("dloSearch").addEventListener("input", renderDlos);
  el("fieldSearch").addEventListener("input", renderFields);
  el("allFieldsBtn").addEventListener("click", () => { state.fields.forEach(f => state.selectedFields.add(f.name)); renderFields(); });
  el("noFieldsBtn").addEventListener("click", () => { state.selectedFields.clear(); renderFields(); });
  el("runBtn").addEventListener("click", runPreview);
  el("useCustomSql").addEventListener("change", () => {
    const checked = el("useCustomSql").checked;
    el("customSql").style.display = checked ? "" : "none";
  });

  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      const id = t.dataset.tab;
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
      t.classList.add("active");
      el(id).classList.add("active");
    });
  });

  el("prevBtn").addEventListener("click", () => {
    const limit = Number(el("limit").value || 100);
    el("offset").value = Math.max(0, Number(el("offset").value || 0) - limit);
    runPreview();
  });

  el("nextBtn").addEventListener("click", () => {
    const limit = Number(el("limit").value || 100);
    el("offset").value = Number(el("offset").value || 0) + limit;
    runPreview();
  });

  el("copySqlBtn").addEventListener("click", async () => {
    await navigator.clipboard.writeText(state.lastSql || "");
    alert("SQL copied.");
  });

  el("csvBtn").addEventListener("click", () => {
    const csv = toCsv(state.lastRows || []);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${state.selectedDlo || "export"}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  init();
</script>
</body>
</html>
